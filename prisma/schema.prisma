generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id        String    @id @default(cuid())
  email     String    @unique
  password  String
  name      String
  isAdmin   Boolean   @default(false)
  createdAt DateTime  @default(now())
  comments  Comment[]
  posts     Post[]
}

model Post {
  id                  String             @id @default(cuid())
  title               String
  slug                String             @unique
  content             String
  excerpt             String?
  categories          String?
  categoryType        String             @default("SPEND_OFFERS")
  bankId              String?
  programId           String?
  isVerified          Boolean?           @default(false)
  expiryDateTime      DateTime?
  showExpiryBadge     Boolean            @default(false)
  expiryDisplayFormat String?            @default("date")
  isActive            Boolean?           @default(true)
  statusBadgeText     String?
  statusBadgeColor    String?
  detailsContent      String?
  detailsImages       String?
  ctaText             String             @default("View Details")
  ctaUrl              String?
  ctaAction           String             @default("overlay")
  published           Boolean            @default(false)
  status              String             @default("draft")
  categoryData        String?
  authorId            String
  createdAt           DateTime           @default(now())
  updatedAt           DateTime           @updatedAt
  categoryRelations   CategoryRelation[]
  comments            Comment[]
  author              User               @relation(fields: [authorId], references: [id])
  bank                Bank?              @relation(fields: [bankId], references: [id])
  program             Program?           @relation("ProgramPosts", fields: [programId], references: [id])

  @@index([categoryType])
  @@index([bankId])
  @@index([programId])
  @@index([status])
  @@index([expiryDateTime])
}

model Comment {
  id         String   @id @default(cuid())
  content    String
  postId     String
  userId     String?
  authorName String
  createdAt  DateTime @default(now())
  post       Post     @relation(fields: [postId], references: [id], onDelete: Cascade)
  user       User?    @relation(fields: [userId], references: [id])
}

model Category {
  id          String             @id @default(cuid())
  name        String             @unique
  slug        String             @unique
  label       String
  description String?
  color       String             @default("bg-gray-100 text-gray-800")
  parentId    String?
  createdAt   DateTime           @default(now())
  updatedAt   DateTime           @updatedAt
  parent      Category?          @relation("CategoryToCategory", fields: [parentId], references: [id], onDelete: Cascade)
  children    Category[]         @relation("CategoryToCategory")
  posts       CategoryRelation[]
}

model CategoryRelation {
  id         String   @id @default(cuid())
  postId     String
  categoryId String
  createdAt  DateTime @default(now())
  category   Category @relation(fields: [categoryId], references: [id], onDelete: Cascade)
  post       Post     @relation(fields: [postId], references: [id], onDelete: Cascade)

  @@unique([postId, categoryId])
}

model Bank {
  id          String   @id @default(cuid())
  name        String   @unique
  slug        String   @unique
  logo        String?
  brandColor  String?
  description String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  posts       Post[]

  @@index([slug])
}

model Program {
  id          String   @id @default(cuid())
  name        String   @unique
  slug        String   @unique
  type        String
  logo        String?
  brandColor  String?
  description String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  posts       Post[]   @relation("ProgramPosts")

  @@index([slug])
  @@index([type])
}

model CardConfig {
  id                   String   @id @default(cuid())
  categoryType         String   @unique
  displayName          String
  description          String?
  formSchema           String
  renderConfig         String
  requiresBank         Boolean  @default(false)
  requiresExpiry       Boolean  @default(false)
  supportsVerification Boolean  @default(false)
  supportsActive       Boolean  @default(false)
  supportsAuthor       Boolean  @default(false)
  cardLayout           String   @default("standard")
  sortOrder            Int      @default(0)
  isEnabled            Boolean  @default(true)
  createdAt            DateTime @default(now())
  updatedAt            DateTime @updatedAt

  @@index([categoryType])
  @@index([isEnabled])
}

model RawTweet {
  id            String       @id @default(cuid())
  tweetUrl      String       @unique
  tweetId       String       @unique
  content       String
  authorHandle  String
  authorName    String
  postedAt      DateTime
  fetchedAt     DateTime     @default(now())
  processed     Boolean      @default(false)
  isRelevant    Boolean?
  isDuplicate   Boolean      @default(false)
  processedPost PendingPost?

  @@index([processed, isRelevant])
  @@index([authorHandle])
}

model PendingPost {
  id                  String    @id @default(cuid())
  rawTweetId          String    @unique
  category            String
  extractedData       String
  confidence          Float
  status              String    @default("pending_review")
  lowConfidenceFields String?
  reviewerNotes       String?
  adminNotes          String?
  reviewedBy          String?
  reviewedAt          DateTime?
  publishedPostId     String?   @unique
  createdAt           DateTime  @default(now())
  updatedAt           DateTime  @updatedAt
  rawTweet            RawTweet  @relation(fields: [rawTweetId], references: [id], onDelete: Cascade)

  @@index([status])
  @@index([category])
  @@index([confidence])
}
